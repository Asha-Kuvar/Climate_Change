<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Climate Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Existing print styles remain unchanged */
        @media print {

            .navbar,
            .footer,
            #generateReportBtn,
            .btn,
            .modal,
            .form-label1 {
                display: none !important;
            }

            body {
                background-color: white !important;
                color: black !important;
                font-size: 12pt;
                margin: 1cm;
            }

            .card {
                background-color: white !important;
                color: black !important;
                border: 1px solid #000 !important;
                margin-bottom: 20px;
                page-break-inside: avoid;
            }

            #map {
                height: 400px !important;
                width: 100% !important;
                border: 1px solid #000 !important;
                margin-bottom: 20px;
            }

            .leaflet-tile {
                filter: grayscale(100%) !important;
            }

            .print-map-title {
                display: block;
                text-align: center;
                font-size: 16pt;
                margin-bottom: 10px;
            }

            canvas {
                width: 100% !important;
                height: auto !important;
            }

            .print-title {
                display: block;
                text-align: center;
                font-size: 24px;
                margin-bottom: 20px;
            }

            .section {
                page-break-before: always;
            }

            table,
            img,
            canvas {
                max-width: 100% !important;
                height: auto !important;
            }

            @page {
                size: A4;
                margin: 1cm;
            }
        }

        /* Default styles (Dark mode) */
        body {
            background: linear-gradient(135deg, #111 0%, #1a1a1a 100%);

            color: #e0e0e0;

            font-family: 'Poppins', sans-serif;

            scroll-behavior: smooth;
            margin: 0;
            padding: 0;
        }

        #map {
            height: 400px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);

            transition: transform 0.3s ease;

        }

        #map:hover {
            transform: scale(1.02);

        }

        .card {
            background: linear-gradient(145deg, #222, #2a2a2a);

            color: #e0e0e0;
            border: none;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);

            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.5);
        }

        .form-label1 {
            color: #e0e0e0;
            font-weight: 500;
        }

        .navbar {
            background: linear-gradient(to right, #0d1b2a, #1b263b);

            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            padding: 15px 0;

        }

        .navbar-brand,
        .nav-link {
            color: #fff !important;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: color 0.3s ease;
        }

        .navbar-brand:hover,
        .nav-link:hover {
            color: #00d4ff !important;

        }

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        /* .wrapper {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        } */

        .content {
            flex: 1 0 auto;
        }

        .footer {
            background: linear-gradient(to right, #0d1b2a, #1b263b);
            color: #e0e0e0;
            text-align: center;
            padding: 20px;
            width: 100%;
            flex-shrink: 0;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
        }

        .section {
            padding: 80px 0;

            position: relative;
            overflow: hidden;
        }

        .section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.05), transparent);
            z-index: -1;
        }

        /* Report generation styles */
        #reportModal .modal-body {
            max-height: 70vh;
            overflow-y: auto;
            background: #fff;
            border-radius: 10px;
        }

        #reportForm .form-check {
            margin-bottom: 0.75rem;
        }

        .report-loading {
            display: none;
            text-align: center;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
        }

        .report-loading.active {
            display: block;
        }

        #reportModal label {
            color: #333;
            font-weight: 500;
        }

        /* Legend styles */
        .legend {
            padding: 12px;
            background: rgba(0, 0, 0, 0.85);
            color: #e0e0e0;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.6;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .legend i {
            width: 20px;
            height: 20px;
            float: left;
            margin-right: 10px;
            opacity: 0.8;
            border-radius: 50%;

        }

        .loading-spinner {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }

        .data-container {
            position: relative;
            min-height: 200px;
        }

        .compare-checkbox {
            margin: 15px 0;
            font-size: 1.1rem;
        }

        .compare-checkbox .form-check-input {
            width: 1.5em;
            height: 1.5em;
            cursor: pointer;
        }

        .theme-toggle {
            position: fixed;
            bottom: 25px;
            right: 25px;
            z-index: 1000;
        }

        .theme-toggle .btn {
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: background-color 0.3s ease, transform 0.3s ease;
        }

        .theme-toggle .btn:hover {
            transform: scale(1.1);
            background-color: #00d4ff;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.6s ease-out forwards;
        }

        /* Buttons */
        .btn-primary {
            background: linear-gradient(45deg, #00aaff, #007bff);
            border: none;
            padding: 10px 20px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: linear-gradient(45deg, #007bff, #0056b3);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 123, 255, 0.4);
        }

        .btn-light {
            background: #fff;
            color: #333;
            border: none;
            padding: 10px 20px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-light:hover {
            background: #e9ecef;
            color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }

        /* Light Theme Styles */
        body.light-theme {
            background: linear-gradient(135deg, #f5f6f5 0%, #e9ecef 100%);
            color: #2a2a2a;

        }

        .light-theme .navbar {
            background: linear-gradient(to right, #ffffff, #f8f9fa);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .light-theme .navbar-brand,
        .light-theme .nav-link {
            color: #2a2a2a !important;
        }

        .light-theme .navbar-brand:hover,
        .light-theme .nav-link:hover {
            color: #007bff !important;
        }

        .light-theme .card {
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            color: #2a2a2a;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            border: 1px solid #e9ecef;
        }

        .light-theme .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
        }

        .light-theme .form-label1 {
            color: #495057;
            font-weight: 500;
        }

        .light-theme .footer {
            background: linear-gradient(to right, #ffffff, #f8f9fa);
            color: #2a2a2a;
            border-top: 1px solid #e9ecef;
        }

        .light-theme #map {
            border: 1px solid #d3d3d3;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .light-theme #map:hover {
            transform: scale(1.02);
        }

        .light-theme .btn-light {
            background: linear-gradient(45deg, #f8f9fa, #ffffff);
            color: #2a2a2a;
        }

        .light-theme .btn-light:hover {
            background: linear-gradient(45deg, #e9ecef, #f8f9fa);
            color: #007bff;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }

        .light-theme .btn-primary {
            background: linear-gradient(45deg, #00aaff, #007bff);
        }

        .light-theme .btn-primary:hover {
            background: linear-gradient(45deg, #007bff, #0056b3);
            box-shadow: 0 6px 15px rgba(0, 123, 255, 0.4);
        }

        .light-theme .modal-content {
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            color: #2a2a2a;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            border: none;
        }

        .light-theme .legend {
            background: rgba(255, 255, 255, 0.95);
            color: #2a2a2a;
            border: 1px solid #d3d3d3;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .light-theme .form-control {
            background: #ffffff;
            color: #2a2a2a;
            border: 1px solid #ced4da;
            border-radius: 8px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .light-theme .form-control:focus {
            border-color: #007bff;
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.3);
        }

        .light-theme .theme-toggle .btn {
            background: linear-gradient(45deg, #6c757d, #868e96);
            color: #fff;
        }

        .light-theme .theme-toggle .btn:hover {
            background: linear-gradient(45deg, #5a6268, #6c757d);
            transform: scale(1.1);
        }

        .light-theme .card.bg-dark {
            background: linear-gradient(145deg, #ffffff, #f8f9fa) !important;
            color: #2a2a2a !important;
        }

        .light-theme .compare-mode .country-card {
            border: 2px solid #007bff;
            box-shadow: 0 0 15px rgba(0, 123, 255, 0.4);
        }

        /* Additional attractive styles */
        h2,
        h3,
        h4,
        h5 {
            font-weight: 700;
            letter-spacing: 0.5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);

        }

        .light-theme h2,
        .light-theme h3,
        .light-theme h4,
        .light-theme h5 {
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Chart cards */
        .card.bg-dark {
            transition: background 0.3s ease;
        }

        /* Compare UI */
        #compareUI {
            background: rgba(0, 0, 0, 0.9);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
            transition: opacity 0.3s ease;
        }

        .light-theme #compareUI {
            background: rgba(255, 255, 255, 0.95);
            color: #2a2a2a;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        .modal-title,
        .form-label {
            margin-left: 2%;
        }

        /* Modal enhancements */
        /* .modal-content {
            border-radius: 15px;
            overflow: hidden;
        }

        .modal-header {
            background: linear-gradient(to right, #0d1b2a, #1b263b);
            color: #fff;
            border-bottom: none;
        }

        .light-theme .modal-header {
            background: linear-gradient(to right, #007bff, #00aaff);
            color: #fff;
        } */

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .legend {
                font-size: 11px;
                padding: 8px;
            }

            .theme-toggle {
                bottom: 15px;
                right: 15px;
            }

            .theme-toggle .btn {
                width: 40px;
                height: 40px;
            }

            .section {
                padding: 40px 0;
            }

            .card {
                margin-bottom: 15px;
            }
        }
    </style>
</head>

<body>
    <div class="wrapper">
        <nav class="navbar navbar-expand-lg">
            <div class="container">
                <a class="navbar-brand fw-bold" href="#">🌍 Climate Change Impacts Visualizer</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item"><a class="nav-link" href="#mapSection">Home</a></li>
                        <li class="nav-item"><a class="nav-link" href="#charts">Charts</a></li>
                        <li class="nav-item"><a class="nav-link" href="#simulator">Simulation</a></li>
                        <li class="nav-item"><a class="nav-link" href="#contact">Contact Us</a></li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="content">
            <div class="container text-center section fade-in" id="mapSection">
                <h2 class="fw-bold">Climate Dashboard</h2>
                <p>How unusual is the current climate?</p>
                <div id="map"></div>
                <div class="loading-spinner" id="mapLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div class="compare-checkbox form-check form-switch">
                    <input class="form-check-input me-5" type="checkbox" id="compareMode">
                    <label class="form-check-label" for="compareMode">Compare Countries Mode</label>
                </div>

                <div class="row mt-4">

                    <div class="col-md-4">
                        <div class="card p-3 text-center h-100">
                            <h5>🌡️ Temperature</h5>
                            <h4 id="temperature" class="fw-bold">Loading...</h4>
                            <h5>(Current temperature)</h5>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card p-3 text-center h-100">
                            <h5>🌍 CO₂ Emissions</h5>
                            <h4 id="co2Emissions" class="fw-bold">Loading...</h4>
                            <h5>(Global CO₂ emissions per year)</h5>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card p-3 text-center h-100">
                            <h5>🌲 Deforestation Rate</h5>
                            <h4 id="deforestationRate" class="fw-bold">Loading...</h4>
                            <h5>(Forests lost annually)</h5>
                        </div>
                    </div>
                </div>
                <div class="d-flex flex-column align-items-center justify-content-center text-center mt-3">
                    <h2 id="location">Loading...</h2>
                    <!-- Example for location modal trigger -->
                    <button class="btn btn-light mt-2" data-bs-toggle="modal" data-bs-target="#locationModal">
                        Change Location
                    </button>
                </div>
                <div class="modal fade" id="locationModal" tabindex="-1" aria-labelledby="locationModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="locationModalLabel">Select Country</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <select id="countrySelect" class="form-select">
                                    <option value="">Loading...</option>
                                </select>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" id="updateLocation">Update</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="container text-center mt-5 fade-in" id="charts">
                    <div class="row mt-4">
                        <div class="col-md-4">
                            <div class="card bg-dark text-white h-100 py-4">
                                <div class="card-body">
                                    <h5 class="card-title text-center">Temperature Trends</h5><canvas
                                        id="chart1"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-dark text-white h-100 py-4">
                                <div class="card-body">
                                    <h5 class="card-title text-center">CO2 Emissions</h5><canvas id="chart2"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-dark text-white h-100 py-4">
                                <div class="card-body">
                                    <h5 class="card-title text-center">Deforestation Rate</h5><canvas
                                        id="chart3"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="container text-center mt-5">
                    <h3>Climate Prediction</h3>
                    <p>Select a country and year to predict climate factors.</p>
                    <form id="predictionForm">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="predictionCountry" class="form-label">Select Country</label>
                                <select id="predictionCountry" class="form-select">
                                    <option value="">Loading...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="predictionYear" class="form-label">Enter Year</label>
                                <input type="number" class="form-control" id="predictionYear" placeholder="e.g., 2030"
                                    min="2023" max="2100">
                            </div>
                        </div>
                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary">Predict</button>
                        </div>
                    </form>
                </div>

                <div class="container text-center mt-4" id="predictionResults">
                    <h4>Prediction Results</h4>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card p-3 text-center h-100">
                                <h5>🌡️ Predicted Temperature</h5>
                                <h4 id="predictedTemperature" class="fw-bold">-</h4>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card p-3 text-center h-100">
                                <h5>🌍 Predicted CO₂ Emissions</h5>
                                <h4 id="predictedCO2" class="fw-bold">-</h4>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card p-3 text-center h-100">
                                <h5>🌲 Predicted Deforestation Rate</h5>
                                <h4 id="predictedDeforestation" class="fw-bold">-</h4>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="simulator">
                    <div class="card bg-dark text-white mt-5 fade-in">
                        <div class="card-body">
                            <h3 class="card-title text-center">Simulation Tool</h3>
                            <p class="text-center">Adjust the values below to see their impact on climate factors.</p>
                            <form id="simulationForm">
                                <!-- <div class="row">
                                <div class="col-md-4">
                                    <label for="temperatureChange" class="form-label1 mb-2">Temperature Change
                                        (°C)</label>
                                    <input type="number" class="form-control" id="temperatureChange"
                                        placeholder="e.g., 2">
                                </div>
                                <div class="col-md-4">
                                    <label for="co2Level" class="form-label1 mb-2">CO2 Level (ppm)</label>
                                    <input type="number" class="form-control" id="co2Level" placeholder="e.g., 400">
                                </div>
                            </div> -->
                                <div class="row">
                                    <div class="col-md-4">
                                        <label for="temperatureChange" class="form-label1 mb-2">Temperature Change
                                            (°C)</label>
                                        <input type="number" class="form-control" id="temperatureChange"
                                            placeholder="e.g., 2" step="0.1">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="co2Level" class="form-label1 mb-2">CO2 Level (ppm)</label>
                                        <input type="number" class="form-control" id="co2Level" placeholder="e.g., 400"
                                            step="1">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="deforestationChange" class="form-label1 mb-2">Deforestation Change
                                            (%)</label>
                                        <input type="number" class="form-control" id="deforestationChange"
                                            placeholder="e.g., 5" step="0.1">
                                    </div>
                                </div>
                                <div class="text-center mt-4">
                                    <button type="submit" class="btn btn-light">Simulate Impact</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <!-- <div class="text-center mt-4">
                    <button id="generateReportBtn" class="btn btn-primary">Generate Localized Report</button>
                </div> -->

                <!-- Replace your existing button with this -->
                <button class="btn btn-primary mt-3" id="generateReportBtn">
                    <i class="fas fa-file-pdf me-2"></i> Generate Custom Report
                </button>

                <!-- <div id="contact">
                    <div class="container text-center my-3 fade-in">
                        <p>If you notice problems with the data, or want to suggest improvements, contact us:</p>
                        <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#contactModal">
                            Contact Us
                        </button>
                    </div>
                    <div class="modal fade" id="contactModal" tabindex="-1" aria-labelledby="contactModalLabel"
                        aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title text-dark" id="contactModalLabel">Contact Us</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="contactForm">
                                        <div class="mb-3 row">
                                            <label for="name" class="col-sm-3 col-form-label text-dark">Name:</label>
                                            <div class="col-sm-9">
                                                <input type="text" class="form-control" id="name"
                                                    placeholder="Enter your name" required>
                                            </div>
                                        </div>
                                        <div class="mb-3 row">
                                            <label for="email" class="col-sm-3 col-form-label text-dark">Email:</label>
                                            <div class="col-sm-9">
                                                <input type="email" class="form-control" id="email"
                                                    placeholder="Enter your email" required>
                                            </div>
                                        </div>
                                        <div class="mb-3 row">
                                            <label for="mobile"
                                                class="col-sm-3 col-form-label text-dark">Mobile:</label>
                                            <div class="col-sm-9">
                                                <input type="tel" class="form-control" id="mobile"
                                                    placeholder="Enter your mobile number" required>
                                            </div>
                                        </div>
                                        <div class="mb-3 row">
                                            <label for="message"
                                                class="col-sm-3 col-form-label text-dark">Message:</label>
                                            <div class="col-sm-9">
                                                <textarea class="form-control" id="message" rows="4"
                                                    placeholder="Enter your message" required></textarea>
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-primary w-100">Submit</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> -->

                <div id="contact">
                    <div class="container text-center my-5 fade-in">
                        <p>If you notice problems with the data, or want to suggest improvements, contact us:</p>
                        <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#contactModal">Contact Us</button>
                    </div>
    
                    <div class="modal fade" id="contactModal" tabindex="-1" aria-labelledby="contactModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title text-dark" id="contactModalLabel">Contact Us</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form>
                                        <div class="mb-3 row">
                                            <label for="name" class="col-sm-3 col-form-label text-dark">Name:</label>
                                            <div class="col-sm-9">
                                                <input type="text" class="form-control" id="name" placeholder="Enter your name">
                                            </div>
                                        </div>
                                        <div class="mb-3 row">
                                            <label for="email" class="col-sm-3 col-form-label text-dark">Email:</label>
                                            <div class="col-sm-9">
                                                <input type="email" class="form-control" id="email" placeholder="Enter your email">
                                            </div>
                                        </div>
                                        <div class="mb-3 row">
                                            <label for="mobile" class="col-sm-3 col-form-label text-dark">Mobile:</label>
                                            <div class="col-sm-9">
                                                <input type="tel" class="form-control" id="mobile" placeholder="Enter your mobile number">
                                            </div>
                                        </div>
                                        <div class="mb-3 row">
                                            <label for="message" class="col-sm-3 col-form-label text-dark">Message:</label>
                                            <div class="col-sm-9">
                                                <textarea class="form-control" id="message" rows="4" placeholder="Enter your message"></textarea>
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-primary w-100">Submit</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Theme Toggle Button -->
            <div class="theme-toggle">
                <button id="themeToggle" class="btn btn-secondary">
                    <i class="fas fa-moon"></i> Toggle Theme
                </button>
            </div>

            <footer class="footer">
                <p>© 2025 Climate Change Dashboard | All Rights Reserved</p>
            </footer>
        </div>

        <!-- Load these in this order -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/js/all.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
        <!-- <script>
            var map = L.map('map').setView([20, 0], 2);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            let geoJsonLayer;
            let climateData = {};

            async function fetchClimateDataForCountry(country) {
                try {
                    const [tempRes, co2Res, countryInfoRes] = await Promise.all([
                        fetch(`/api/current_temperature?country=${encodeURIComponent(country)}`),
                        fetch(`/api/nasa/co2?country=${encodeURIComponent(country)}`),
                        fetch(`/api/country_info?country=${encodeURIComponent(country)}`)
                    ]);
                    const tempData = await tempRes.json();
                    const co2Data = await co2Res.json();
                    const countryInfo = await countryInfoRes.json();
                    return {
                        temperature: tempData.error ? 25 : tempData.temperature,
                        co2: co2Data.error ? 415 : co2Data.co2_level,
                        deforestation: countryInfo.error ? 10 : countryInfo.deforestation_rate
                    };
                } catch (error) {
                    console.error(`Error fetching data for ${country}:`, error);
                    return { temperature: 25, co2: 415, deforestation: 10 };
                }
            }

            function calculateClimateScore(temp, co2, deforest) {
                const tempNorm = Math.min((temp + 20) / 60, 1) * 100;
                const co2Norm = Math.min((co2 - 300) / 200, 1) * 100;
                const deforestNorm = Math.min(deforest / 50, 1) * 100;
                return (tempNorm * 0.4 + co2Norm * 0.4 + deforestNorm * 0.2);
            }

            function getColor(score) {
                return score > 80 ? '#800026' :
                    score > 60 ? '#BD0026' :
                        score > 40 ? '#E31A1C' :
                            score > 20 ? '#FC4E2A' :
                                '#FFEDA0';
            }

            fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json')
                .then(response => response.json())
                .then(geojsonData => {
                    geoJsonLayer = L.geoJson(geojsonData, {
                        style: function (feature) {
                            const country = feature.properties.name;
                            const data = climateData[country] || { temperature: 25, co2: 415, deforestation: 10 };
                            const score = calculateClimateScore(data.temperature, data.co2, data.deforestation);
                            return {
                                fillColor: getColor(score),
                                weight: 1,
                                opacity: 1,
                                color: 'white',
                                fillOpacity: 0.7
                            };
                        },
                        onEachFeature: function (feature, layer) {
                            const country = feature.properties.name;
                            layer.on('click', async () => {
                                const data = await fetchClimateDataForCountry(country);
                                climateData[country] = data;
                                const score = calculateClimateScore(data.temperature, data.co2, data.deforestation);
                                layer.setStyle({ fillColor: getColor(score) });
                                layer.bindPopup(
                                    `<b>${country}</b><br>` +
                                    `Temp: ${data.temperature}°C<br>` +
                                    `CO₂: ${data.co2} ppm<br>` +
                                    `Deforestation: ${data.deforestation}%<br>` +
                                    `Climate Score: ${score.toFixed(1)}`
                                ).openPopup();
                            });
                        }
                    }).addTo(map);
                })
                .catch(error => console.error("Error loading GeoJSON:", error));

            async function fetchCountryInfo(countryName) {
                try {
                    const tempResponse = await fetch(`/api/current_temperature?country=${encodeURIComponent(countryName)}`);
                    const tempData = await tempResponse.json();
                    document.getElementById("temperature").textContent = tempData.error ? "N/A" : `${tempData.temperature}°C`;

                    const co2Response = await fetch(`/api/nasa/co2?country=${encodeURIComponent(countryName)}`);
                    const co2Data = await co2Response.json();
                    document.getElementById("co2Emissions").textContent = co2Data.error ? "N/A" : `${co2Data.co2_level} ppm`;

                    const dbResponse = await fetch(`/api/country_info?country=${encodeURIComponent(countryName)}`);
                    const dbData = await dbResponse.json();
                    document.getElementById("deforestationRate").textContent = dbData.error ? "N/A" : `${dbData.deforestation_rate}%`;
                    document.getElementById("location").textContent = countryName;

                    fetchTemperatureData(countryName);
                    fetchCO2EmissionsData(countryName);
                    fetchDeforestationData(countryName);

                    const countryData = await (await fetch(`https://restcountries.com/v3.1/name/${encodeURIComponent(countryName)}`)).json();
                    if (countryData && countryData[0]?.latlng) {
                        const [lat, lon] = countryData[0].latlng;
                        map.setView([lat, lon], 5);
                        map.eachLayer(layer => { if (layer instanceof L.Marker) map.removeLayer(layer); });
                        L.marker([lat, lon]).addTo(map)
                            .bindPopup(`<b>${countryName}</b><br>${tempData.temperature || "N/A"}°C`)
                            .openPopup();

                        climateData[countryName] = await fetchClimateDataForCountry(countryName);
                        geoJsonLayer.eachLayer(layer => {
                            if (layer.feature.properties.name === countryName) {
                                const score = calculateClimateScore(
                                    climateData[countryName].temperature,
                                    climateData[countryName].co2,
                                    climateData[countryName].deforestation
                                );
                                layer.setStyle({ fillColor: getColor(score) });
                            }
                        });
                    }
                } catch (error) {
                    console.error("Error in fetchCountryInfo:", error);
                    document.getElementById("location").textContent = "Error loading location";
                }
            }

            function getUserLocation() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            const { latitude, longitude } = position.coords;
                            try {
                                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json`);
                                const data = await response.json();
                                const country = data.address?.country || "India"; // Fallback to India if country not found
                                console.log(`User location detected: ${country}`);
                                await fetchCountryInfo(country); // Fetch data for user's country
                            } catch (error) {
                                console.error("Error fetching country from coordinates:", error);
                                await fetchCountryInfo("India"); // Fallback to India
                            }
                        },
                        (error) => {
                            console.error("Geolocation error:", error.message);
                            fetchCountryInfo("India"); // Fallback to India if geolocation fails
                        }
                    );
                } else {
                    console.error("Geolocation not supported by this browser.");
                    fetchCountryInfo("India"); // Fallback to India
                }
            }

            async function fetchTemperatureData(country) {
                try {
                    const response = await fetch(`/api/temperature?country=${encodeURIComponent(country)}`);
                    const tempData = await response.json();
                    if (!tempData.length) return;

                    const labels = tempData.map(d => d.year.toString());
                    const avgTemps = tempData.map(d => d.avg_temperature);

                    const existingChart = Chart.getChart("chart1");
                    if (existingChart) existingChart.destroy();

                    new Chart(document.getElementById("chart1"), {
                        type: 'line',
                        data: {
                            labels,
                            datasets: [{
                                label: `Avg Temperature in ${country} (°C)`,
                                data: avgTemps,
                                borderColor: "red",
                                fill: false
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                x: { type: 'linear', ticks: { stepSize: 2, callback: value => Number(value).toFixed(0) } }
                            }
                        }
                    });
                } catch (error) {
                    console.error("Error fetching temperature data:", error);
                }
            }

            async function fetchCO2EmissionsData(country) {
                try {
                    const response = await fetch(`/api/co2-emissions?country=${encodeURIComponent(country)}`);
                    const co2Data = await response.json();
                    if (!co2Data.length) return;

                    const labels = co2Data.map(d => d.year.toString());
                    const emissions = co2Data.map(d => d.co2_emissions);

                    const existingChart = Chart.getChart("chart2");
                    if (existingChart) existingChart.destroy();

                    new Chart(document.getElementById("chart2"), {
                        type: 'line',
                        data: {
                            labels,
                            datasets: [{
                                label: `CO₂ Emissions in ${country} (ppm)`,
                                data: emissions,
                                borderColor: "blue",
                                fill: false
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                x: { type: 'linear', ticks: { stepSize: 2, callback: value => Number(value).toFixed(0) } }
                            }
                        }
                    });
                } catch (error) {
                    console.error("Error fetching CO₂ emissions data:", error);
                }
            }

            async function fetchDeforestationData(country) {
                try {
                    const response = await fetch(`/api/deforestation?country=${encodeURIComponent(country)}`);
                    const deforestationData = await response.json();
                    if (!deforestationData.length) return;

                    const existingChart = Chart.getChart("chart3");
                    if (existingChart) existingChart.destroy();

                    new Chart(document.getElementById("chart3"), {
                        type: 'scatter',
                        data: {
                            datasets: [{
                                label: `Deforestation vs Temperature Rise (${country})`,
                                data: deforestationData.map(d => ({ x: d.deforestation_rate, y: d.avg_temperature })),
                                backgroundColor: "green",
                                pointRadius: 5
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                x: { title: { display: true, text: "Forests Lost (%)" } },
                                y: { title: { display: true, text: "Temperature Rise (°C)" } }
                            }
                        }
                    });
                } catch (error) {
                    console.error("Error fetching deforestation data:", error);
                }
            }

            document.getElementById("updateLocation").addEventListener("click", function () {
                const selectedCountry = document.getElementById("countrySelect").value;
                if (selectedCountry) {
                    fetchCountryInfo(selectedCountry);
                    fetchTemperatureData(selectedCountry);
                    fetchCO2EmissionsData(selectedCountry);
                    fetchDeforestationData(selectedCountry);
                }
            });

            // document.getElementById("simulationForm").addEventListener("submit", function (event) {
            //     event.preventDefault();
            //     const temperatureChange = parseFloat(document.getElementById("temperatureChange").value);
            //     const co2Level = parseFloat(document.getElementById("co2Level").value);

            //     if (isNaN(temperatureChange) || isNaN(co2Level)) {
            //         alert("Please enter valid numbers for all fields.");
            //         return;
            //     }

            //     fetch('/api/predicts', {
            //         method: 'POST',
            //         headers: { 'Content-Type': 'application/json' },
            //         body: JSON.stringify({ temperatureChange, co2Level })
            //     })
            //         .then(response => response.json())
            //         .then(data => {
            //             document.getElementById("predictedTemperature").textContent = `${data.predicted_temperature_c}°C`;
            //             document.getElementById("predictedCO2").textContent = `${data.predicted_co2_emissions_mmt} ppm`;
            //         })
            //         .catch(error => {
            //             console.error("Fetch Error:", error);
            //             alert("Failed to fetch simulation results.");
            //         });
            // });

            document.getElementById("simulationForm").addEventListener("submit", async function (event) {
                event.preventDefault();

                // Get input values with fallback defaults
                const temperatureChange = parseFloat(document.getElementById("temperatureChange").value) || 0;
                const co2Level = parseFloat(document.getElementById("co2Level").value) || 400;
                const deforestationChange = parseFloat(document.getElementById("deforestationChange").value) || 0;

                try {
                    const response = await fetch('/api/predicts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ temperatureChange, co2Level, deforestationChange })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }

                    const data = await response.json();

                    // Check if the expected fields are in the response
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    // Update UI with simulation results
                    document.getElementById("predictedTemperature").textContent = `${data.predicted_temperature_c || '-'}°C`;
                    document.getElementById("predictedCO2").textContent = `${data.predicted_co2_emissions_mmt || '-'} ppm`;
                    document.getElementById("predictedDeforestation").textContent = `${data.predicted_deforestation_rate_percent || '-'}%`;

                } catch (error) {
                    console.error("Simulation Error:", error);
                    alert("Failed to simulate impact: " + error.message);
                    // Reset UI on error
                    document.getElementById("predictedTemperature").textContent = "-";
                    document.getElementById("predictedCO2").textContent = "-";
                    document.getElementById("predictedDeforestation").textContent = "-";
                }
            });

            document.getElementById("predictionForm").addEventListener("submit", function (event) {
                event.preventDefault();
                const country = document.getElementById("predictionCountry").value;
                const year = document.getElementById("predictionYear").value;

                if (!country || !year) {
                    alert("Please select a country and enter a year.");
                    return;
                }

                fetch(`/api/predict?country=${encodeURIComponent(country)}&year=${year}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) alert(data.error);
                        else {
                            document.getElementById("predictedTemperature").textContent = `${data.predicted_temperature_c}°C`;
                            document.getElementById("predictedCO2").textContent = `${data.predicted_co2_emissions_mmt} ppm`;
                            document.getElementById("predictedDeforestation").textContent = `${data.predicted_deforestation_rate_percent}%`;
                        }
                    })
                    .catch(error => console.error("Error fetching prediction data:", error));
            });

            document.getElementById("generateReportBtn").addEventListener("click", function () {
                window.print();
            });

            document.getElementById("contactForm").addEventListener("submit", function (event) {
                event.preventDefault();
                const name = document.getElementById("name").value;
                const email = document.getElementById("email").value;
                const mobile = document.getElementById("mobile").value;
                const message = document.getElementById("message").value;

                fetch('/contact', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, mobile, message })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) alert(data.error);
                        else {
                            alert("Message sent successfully!");
                            document.getElementById("contactForm").reset();
                            bootstrap.Modal.getInstance(document.getElementById("contactModal")).hide();
                        }
                    })
                    .catch(error => console.error("Error submitting contact form:", error));
            });

            fetch("https://restcountries.com/v3.1/all")
                .then(res => res.json())
                .then(data => {
                    let countrySelect = document.getElementById("countrySelect");
                    let predictionCountrySelect = document.getElementById("predictionCountry");
                    countrySelect.innerHTML = "";
                    predictionCountrySelect.innerHTML = "";
                    data.sort((a, b) => a.name.common.localeCompare(b.name.common));
                    data.forEach(country => {
                        let option = document.createElement("option");
                        option.value = country.name.common;
                        option.textContent = country.name.common;
                        countrySelect.appendChild(option.cloneNode(true));
                        predictionCountrySelect.appendChild(option);
                    });
                })
                .catch(error => console.error("Error loading countries:", error));

            document.addEventListener("DOMContentLoaded", () => {
                getUserLocation(); // Start with user's location
            });
        </script> -->

        <script>
            var map = L.map('map').setView([20, 0], 2);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            let geoJsonLayer;
            let climateData = {};

            async function fetchClimateDataForCountry(country) {
                try {
                    const [tempRes, countryInfoRes] = await Promise.all([
                        fetch(`/api/current_temperature?country=${encodeURIComponent(country)}`),
                        fetch(`/api/country_info?country=${encodeURIComponent(country)}`)
                    ]);

                    const tempData = await tempRes.json();
                    const countryInfo = await countryInfoRes.json();

                    // Use temperature from OpenWeather API, fallback to 25°C if error
                    const temperature = tempData.error ? 25 : tempData.temperature;

                    // Use CO2 and deforestation from database if available, otherwise use defaults
                    const co2 = countryInfo.error || !countryInfo.co2_emissions ? 415 : countryInfo.co2_emissions;
                    const deforestation = countryInfo.error || !countryInfo.deforestation_rate ? 10 : countryInfo.deforestation_rate;

                    return { temperature, co2, deforestation };
                } catch (error) {
                    console.error(`Error fetching data for ${country}:`, error);
                    return { temperature: 25, co2: 415, deforestation: 10 };
                }
            }

            function calculateClimateScore(temp, co2, deforest) {
                const tempNorm = Math.min((temp + 20) / 60, 1) * 100;
                const co2Norm = Math.min((co2 - 300) / 200, 1) * 100;
                const deforestNorm = Math.min(deforest / 50, 1) * 100;
                return (tempNorm * 0.4 + co2Norm * 0.4 + deforestNorm * 0.2);
            }

            // function getColor(score) {
            //     return score > 80 ? '#800026' :
            //         score > 60 ? '#BD0026' :
            //             score > 40 ? '#E31A1C' :
            //                 score > 20 ? '#FC4E2A' :
            //                     '#FFEDA0';
            // }

            fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json')
                .then(response => response.json())
                .then(geojsonData => {
                    geoJsonLayer = L.geoJson(geojsonData, {
                        style: function (feature) {
                            const country = feature.properties.name;
                            const data = climateData[country] || { temperature: 25, co2: 415, deforestation: 10 };
                            const score = calculateClimateScore(data.temperature, data.co2, data.deforestation);
                            return {
                                fillColor: getColor(score),
                                weight: 1,
                                opacity: 1,
                                color: 'white',
                                fillOpacity: 0.7
                            };
                        },
                        onEachFeature: function (feature, layer) {
                            const country = feature.properties.name;
                            layer.on('click', async () => {
                                const data = await fetchClimateDataForCountry(country);
                                climateData[country] = data;
                                const score = calculateClimateScore(data.temperature, data.co2, data.deforestation);
                                layer.setStyle({ fillColor: getColor(score) });

                                // Update dashboard cards with fetched data
                                document.getElementById("temperature").textContent = `${data.temperature}°C`;
                                document.getElementById("co2Emissions").textContent = `${data.co2} ppm`;
                                document.getElementById("deforestationRate").textContent = `${data.deforestation}%`;
                                document.getElementById("location").textContent = country;

                                // Update charts
                                fetchTemperatureData(country);
                                fetchCO2EmissionsData(country);
                                fetchDeforestationData(country);

                                // Show popup on map
                                layer.bindPopup(
                                    `<b>${country}</b><br>` +
                                    `Temp: ${data.temperature}°C<br>` +
                                    `CO₂: ${data.co2} ppm<br>` +
                                    `Deforestation: ${data.deforestation}%<br>` +
                                    `Climate Score: ${score.toFixed(1)}`
                                ).openPopup();
                                console.log(`Opening popup for ${country}`);
                                layer.openPopup();
                                console.log(`Popup opened: ${layer.getPopup().isOpen()}`);

                                // Center map on country
                                const countryData = await (await fetch(`https://restcountries.com/v3.1/name/${encodeURIComponent(country)}`)).json();
                                if (countryData && countryData[0]?.latlng) {
                                    const [lat, lon] = countryData[0].latlng;
                                    map.setView([lat, lon], 5);
                                    map.eachLayer(layer => { if (layer instanceof L.Marker) map.removeLayer(layer); });
                                    L.marker([lat, lon]).addTo(map)
                                        .bindPopup(`<b>${country}</b><br>${data.temperature}°C`)
                                        .openPopup();
                                }
                            });
                        }
                    }).addTo(map);
                })
                .catch(error => console.error("Error loading GeoJSON:", error));

            async function fetchCountryInfo(countryName) {
                try {
                    const tempResponse = await fetch(`/api/current_temperature?country=${encodeURIComponent(countryName)}`);
                    const tempData = await tempResponse.json();
                    const countryInfoResponse = await fetch(`/api/country_info?country=${encodeURIComponent(countryName)}`);
                    const countryInfo = await countryInfoResponse.json();

                    document.getElementById("temperature").textContent = tempData.error ? "N/A" : `${tempData.temperature}°C`;
                    document.getElementById("co2Emissions").textContent = countryInfo.error || !countryInfo.co2_emissions ? "415 ppm" : `${countryInfo.co2_emissions} ppm`;
                    document.getElementById("deforestationRate").textContent = countryInfo.error || !countryInfo.deforestation_rate ? "10%" : `${countryInfo.deforestation_rate}%`;
                    document.getElementById("location").textContent = countryName;

                    fetchTemperatureData(countryName);
                    fetchCO2EmissionsData(countryName);
                    fetchDeforestationData(countryName);

                    const countryData = await (await fetch(`https://restcountries.com/v3.1/name/${encodeURIComponent(countryName)}`)).json();
                    if (countryData && countryData[0]?.latlng) {
                        const [lat, lon] = countryData[0].latlng;
                        map.setView([lat, lon], 5);
                        map.eachLayer(layer => { if (layer instanceof L.Marker) map.removeLayer(layer); });
                        L.marker([lat, lon]).addTo(map)
                            .bindPopup(`<b>${countryName}</b><br>${tempData.temperature || "N/A"}°C`)
                            .openPopup();

                        climateData[countryName] = await fetchClimateDataForCountry(countryName);
                        geoJsonLayer.eachLayer(layer => {
                            if (layer.feature.properties.name === countryName) {
                                const score = calculateClimateScore(
                                    climateData[countryName].temperature,
                                    climateData[countryName].co2,
                                    climateData[countryName].deforestation
                                );
                                layer.setStyle({ fillColor: getColor(score) });
                            }
                        });
                    }
                } catch (error) {
                    console.error("Error in fetchCountryInfo:", error);
                    document.getElementById("location").textContent = "Error loading location";
                }
            }

            function getUserLocation() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            const { latitude, longitude } = position.coords;
                            try {
                                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json`);
                                const data = await response.json();
                                const country = data.address?.country || "India";
                                console.log(`User location detected: ${country}`);
                                await fetchCountryInfo(country);
                            } catch (error) {
                                console.error("Error fetching country from coordinates:", error);
                                await fetchCountryInfo("India");
                            }
                        },
                        (error) => {
                            console.error("Geolocation error:", error.message);
                            fetchCountryInfo("India");
                        }
                    );
                } else {
                    console.error("Geolocation not supported by this browser.");
                    fetchCountryInfo("India");
                }
            }

            async function fetchTemperatureData(country) {
                try {
                    const response = await fetch(`/api/temperature?country=${encodeURIComponent(country)}`);
                    const tempData = await response.json();
                    if (!tempData.length) return;

                    const labels = tempData.map(d => d.year.toString());
                    const avgTemps = tempData.map(d => d.avg_temperature);

                    const existingChart = Chart.getChart("chart1");
                    if (existingChart) existingChart.destroy();

                    new Chart(document.getElementById("chart1"), {
                        type: 'line',
                        data: {
                            labels,
                            datasets: [{
                                label: `Avg Temperature in ${country} (°C)`,
                                data: avgTemps,
                                borderColor: "red",
                                fill: false
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                x: { type: 'linear', ticks: { stepSize: 2, callback: value => Number(value).toFixed(0) } }
                            }
                        }
                    });
                } catch (error) {
                    console.error("Error fetching temperature data:", error);
                }
            }

            async function fetchCO2EmissionsData(country) {
                try {
                    const response = await fetch(`/api/co2-emissions?country=${encodeURIComponent(country)}`);
                    const co2Data = await response.json();
                    if (!co2Data.length) return;

                    const labels = co2Data.map(d => d.year.toString());
                    const emissions = co2Data.map(d => d.co2_emissions);

                    const existingChart = Chart.getChart("chart2");
                    if (existingChart) existingChart.destroy();

                    new Chart(document.getElementById("chart2"), {
                        type: 'line',
                        data: {
                            labels,
                            datasets: [{
                                label: `CO₂ Emissions in ${country} (ppm)`,
                                data: emissions,
                                borderColor: "blue",
                                fill: false
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                x: { type: 'linear', ticks: { stepSize: 2, callback: value => Number(value).toFixed(0) } }
                            }
                        }
                    });
                } catch (error) {
                    console.error("Error fetching CO₂ emissions data:", error);
                }
            }

            async function fetchDeforestationData(country) {
                try {
                    const response = await fetch(`/api/deforestation?country=${encodeURIComponent(country)}`);
                    const deforestationData = await response.json();
                    if (!deforestationData.length) return;

                    const existingChart = Chart.getChart("chart3");
                    if (existingChart) existingChart.destroy();

                    new Chart(document.getElementById("chart3"), {
                        type: 'scatter',
                        data: {
                            datasets: [{
                                label: `Deforestation vs Temperature Rise (${country})`,
                                data: deforestationData.map(d => ({ x: d.deforestation_rate, y: d.avg_temperature })),
                                backgroundColor: "green",
                                pointRadius: 5
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                x: { title: { display: true, text: "Forests Lost (%)" } },
                                y: { title: { display: true, text: "Temperature Rise (°C)" } }
                            }
                        }
                    });
                } catch (error) {
                    console.error("Error fetching deforestation data:", error);
                }
            }

            // document.getElementById("updateLocation").addEventListener("click", function () {
            //     const selectedCountry = document.getElementById("countrySelect").value;
            //     if (selectedCountry) {
            //         // fetchCountryInfo(selectedCountry);
            //         // fetchTemperatureData(selectedCountry);
            //         // fetchCO2EmissionsData(selectedCountry);
            //         // fetchDeforestationData(selectedCountry);

            //     }
            // });

            document.getElementById("updateLocation").addEventListener("click", async function () {
                const selectedCountry = document.getElementById("countrySelect").value;
                if (selectedCountry) {
                    map.closePopup();
                    await fetchCountryInfo(selectedCountry);
                    fetchTemperatureData(selectedCountry);
                    fetchCO2EmissionsData(selectedCountry);
                    fetchDeforestationData(selectedCountry);
                    const modal = bootstrap.Modal.getInstance(document.getElementById("locationModal"));
                    modal.hide(); // Explicitly hide the modal after updating
                }
            });

            document.getElementById("simulationForm").addEventListener("submit", async function (event) {
                event.preventDefault();
                const temperatureChange = parseFloat(document.getElementById("temperatureChange").value) || 0;
                const co2Level = parseFloat(document.getElementById("co2Level").value) || 400;
                const deforestationChange = parseFloat(document.getElementById("deforestationChange").value) || 0;

                try {
                    const response = await fetch('/api/predicts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ temperatureChange, co2Level, deforestationChange })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }

                    const data = await response.json();
                    if (data.error) throw new Error(data.error);

                    document.getElementById("predictedTemperature").textContent = `${data.predicted_temperature_c || '-'}°C`;
                    document.getElementById("predictedCO2").textContent = `${data.predicted_co2_emissions_mmt || '-'} ppm`;
                    document.getElementById("predictedDeforestation").textContent = `${data.predicted_deforestation_rate_percent || '-'}%`;
                } catch (error) {
                    console.error("Simulation Error:", error);
                    alert("Failed to simulate impact: " + error.message);
                    document.getElementById("predictedTemperature").textContent = "-";
                    document.getElementById("predictedCO2").textContent = "-";
                    document.getElementById("predictedDeforestation").textContent = "-";
                }
            });

            document.getElementById("predictionForm").addEventListener("submit", function (event) {
                event.preventDefault();
                const country = document.getElementById("predictionCountry").value;
                const year = document.getElementById("predictionYear").value;

                if (!country || !year) {
                    alert("Please select a country and enter a year.");
                    return;
                }

                fetch(`/api/predict?country=${encodeURIComponent(country)}&year=${year}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) alert(data.error);
                        else {
                            document.getElementById("predictedTemperature").textContent = `${data.predicted_temperature_c}°C`;
                            document.getElementById("predictedCO2").textContent = `${data.predicted_co2_emissions_mmt} ppm`;
                            document.getElementById("predictedDeforestation").textContent = `${data.predicted_deforestation_rate_percent}%`;
                        }
                    })
                    .catch(error => console.error("Error fetching prediction data:", error));
            });

            document.getElementById("generateReportBtn").addEventListener("click", function () {
                window.print();
            });

            // document.getElementById("contactForm").addEventListener("submit", function (event) {
            //     event.preventDefault();
            //     const name = document.getElementById("name").value;
            //     const email = document.getElementById("email").value;
            //     const mobile = document.getElementById("mobile").value;
            //     const message = document.getElementById("message").value;

            //     fetch('/contact', {
            //         method: 'POST',
            //         headers: { 'Content-Type': 'application/json' },
            //         body: JSON.stringify({ name, email, mobile, message })
            //     })
            //         .then(response => response.json())
            //         .then(data => {
            //             if (data.error) {
            //                 alert(data.error);
            //             } else {
            //                 alert("Message sent successfully!");
            //                 document.getElementById("contactForm").reset();
            //                 const modal = bootstrap.Modal.getInstance(document.getElementById("contactModal"));
            //                 modal.hide(); // Explicitly hide the modal after submission
            //             }
            //         })
            //         .catch(error => console.error("Error submitting contact form:", error));
            // });

            document.querySelector('#contactModal form').addEventListener('submit', function (event) {
            event.preventDefault();
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const mobile = document.getElementById('mobile').value;
            const message = document.getElementById('message').value;

            fetch('/contact', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, email, mobile, message })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) alert(data.error);
                    else {
                        alert(data.success);
                        document.querySelector('#contactModal form').reset();
                        document.querySelector('#contactModal .btn-close').click();
                    }
                })
                .catch(error => console.error('Error:', error));
        });

            fetch("https://restcountries.com/v3.1/all")
                .then(res => res.json())
                .then(data => {
                    let countrySelect = document.getElementById("countrySelect");
                    let predictionCountrySelect = document.getElementById("predictionCountry");
                    countrySelect.innerHTML = "";
                    predictionCountrySelect.innerHTML = "";
                    data.sort((a, b) => a.name.common.localeCompare(b.name.common));
                    data.forEach(country => {
                        let option = document.createElement("option");
                        option.value = country.name.common;
                        option.textContent = country.name.common;
                        countrySelect.appendChild(option.cloneNode(true));
                        predictionCountrySelect.appendChild(option);
                    });
                })
                .catch(error => console.error("Error loading countries:", error));

            document.addEventListener("DOMContentLoaded", () => {
                getUserLocation();
            });

            // Add this to your existing JavaScript
            function initReportGeneration() {
                // Populate country dropdown
                const reportCountrySelect = document.getElementById('reportCountry');
                const countrySelect = document.getElementById('countrySelect');
                reportCountrySelect.innerHTML = countrySelect.innerHTML;

                // Set default country to current selection
                reportCountrySelect.value = document.getElementById('location').textContent;

                // Report generation handler
                document.getElementById('generateReportBtn').addEventListener('click', async function () {
                    const country = reportCountrySelect.value;
                    if (!country) {
                        alert('Please select a country');
                        return;
                    }

                    // Get current data
                    const currentData = {
                        country: country,
                        temperature: document.getElementById('temperature').textContent,
                        co2: document.getElementById('co2Emissions').textContent,
                        deforestation: document.getElementById('deforestationRate').textContent
                    };

                    // Get options
                    const options = {
                        includeCurrent: document.getElementById('includeCurrent').checked,
                        includeHistorical: document.getElementById('includeHistorical').checked,
                        includeProjections: document.getElementById('includeProjections').checked,
                        includeRecommendations: document.getElementById('includeRecommendations').checked,
                        title: document.getElementById('reportTitle').value
                    };

                    try {
                        // Show loading state
                        const generateBtn = document.getElementById('generateReportBtn');
                        generateBtn.disabled = true;
                        generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating...';

                        // Generate report
                        const response = await fetch('/api/generate-full-report', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ ...currentData, options })
                        });

                        if (!response.ok) {
                            throw new Error('Failed to generate report');
                        }

                        // Download the PDF
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `climate_report_${country.toLowerCase()}.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);

                        // Close modal
                        bootstrap.Modal.getInstance(document.getElementById('reportModal')).hide();

                    } catch (error) {
                        console.error('Report generation error:', error);
                        alert('Failed to generate report: ' + error.message);
                    } finally {
                        // Reset button
                        const generateBtn = document.getElementById('generateReportBtn');
                        generateBtn.disabled = false;
                        generateBtn.innerHTML = 'Generate Report';
                    }
                });
            }

            // Add these new functions to your existing script
            function addMapLegend() {
                const legend = L.control({ position: 'bottomright' });

                legend.onAdd = function (map) {
                    const div = L.DomUtil.create('div', 'legend');
                    const grades = [0, 20, 40, 60, 80];
                    const labels = [];

                    div.innerHTML = '<h4>Climate Risk Score</h4>';

                    for (let i = 0; i < grades.length; i++) {
                        div.innerHTML +=
                            '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
                            grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
                    }

                    return div;
                };

                legend.addTo(map);
            }

            function toggleTheme() {
                const body = document.body;
                const isDark = body.classList.contains('dark-theme');

                if (isDark) {
                    body.classList.remove('dark-theme');
                    body.classList.add('light-theme');
                    localStorage.setItem('theme', 'light');
                } else {
                    body.classList.remove('light-theme');
                    body.classList.add('dark-theme');
                    localStorage.setItem('theme', 'dark');
                }
            }

            function initTheme() {
                const preferredTheme = localStorage.getItem('theme') || 'dark';
                document.body.classList.add(`${preferredTheme}-theme`);
            }

            function showLoading(elementId) {
                document.getElementById(elementId).style.display = 'block';
            }

            function hideLoading(elementId) {
                document.getElementById(elementId).style.display = 'none';
            }

            // Update your existing DOMContentLoaded event listener
            document.addEventListener("DOMContentLoaded", () => {
                initTheme();
                addMapLegend();
                getUserLocation();

                // Add event listener for theme toggle
                document.getElementById('themeToggle').addEventListener('click', toggleTheme);

                // Add loading indicators to your data fetching functions
                async function fetchCountryInfo(countryName) {
                    showLoading('mapLoading');
                    try {
                        // ... existing fetchCountryInfo code ...
                    } finally {
                        hideLoading('mapLoading');
                    }
                }
            });

            // Add this to your existing styles object
            const lightThemeStyles = {
                body: {
                    backgroundColor: '#f8f9fa',
                    color: '#212529'
                },
                card: {
                    backgroundColor: '#ffffff',
                    color: '#212529',
                    boxShadow: '0 2px 10px rgba(0,0,0,0.1)'
                },
                map: {
                    tileLayer: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
                }
            };

            // Update your existing getColor function to be theme-aware
            function getColor(score) {
                const isDark = document.body.classList.contains('dark-theme');

                if (isDark) {
                    return score > 80 ? '#800026' :
                        score > 60 ? '#BD0026' :
                            score > 40 ? '#E31A1C' :
                                score > 20 ? '#FC4E2A' :
                                    '#FFEDA0';
                } else {
                    return score > 80 ? '#d7191c' :
                        score > 60 ? '#fdae61' :
                            score > 40 ? '#ffffbf' :
                                score > 20 ? '#abd9e9' :
                                    '#2c7bb6';
                }
            }

            // Add this to your existing JavaScript
            let compareMode = false;
            let comparedCountries = [];

            document.getElementById('compareMode').addEventListener('change', function (e) {
                compareMode = e.target.checked;
                if (compareMode) {
                    document.body.classList.add('compare-mode');
                    // Initialize compare mode
                    initCompareMode();
                } else {
                    document.body.classList.remove('compare-mode');
                    // Exit compare mode
                    exitCompareMode();
                }
            });

            function initCompareMode() {
                // Add click handler to map for selecting countries to compare
                map.on('click', async function (e) {
                    const country = await getCountryFromCoordinates(e.latlng);
                    if (country && !comparedCountries.includes(country)) {
                        comparedCountries.push(country);
                        updateCompareView();
                    }
                });

                // Add UI for showing compared countries
                const compareUI = document.createElement('div');
                compareUI.id = 'compareUI';
                compareUI.style.position = 'absolute';
                compareUI.style.top = '10px';
                compareUI.style.right = '10px';
                compareUI.style.zIndex = '1000';
                compareUI.style.backgroundColor = 'rgba(0,0,0,0.7)';
                compareUI.style.padding = '10px';
                compareUI.style.borderRadius = '5px';
                compareUI.style.color = 'white';
                document.getElementById('map').appendChild(compareUI);

                updateCompareView();
            }

            function exitCompareMode() {
                comparedCountries = [];
                map.off('click');
                const compareUI = document.getElementById('compareUI');
                if (compareUI) {
                    compareUI.remove();
                }
            }

            async function updateCompareView() {
                const compareUI = document.getElementById('compareUI');
                if (!compareUI) return;

                if (comparedCountries.length === 0) {
                    compareUI.innerHTML = '<p>Click on countries to compare</p>';
                    return;
                }

                compareUI.innerHTML = '<h5>Comparing Countries:</h5>';
                comparedCountries.forEach(country => {
                    const countryEl = document.createElement('div');
                    countryEl.textContent = country;
                    compareUI.appendChild(countryEl);
                });

                // Add button to fetch comparison data
                const compareBtn = document.createElement('button');
                compareBtn.textContent = 'Compare Data';
                compareBtn.className = 'btn btn-sm btn-primary mt-2';
                compareBtn.onclick = fetchComparisonData;
                compareUI.appendChild(compareBtn);
            }

            async function fetchComparisonData() {
                if (comparedCountries.length < 2) {
                    alert('Please select at least 2 countries to compare');
                    return;
                }

                try {
                    showLoading('mapLoading');
                    const response = await fetch('/api/compare', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ countries: comparedCountries })
                    });

                    const data = await response.json();
                    displayComparisonResults(data);
                } catch (error) {
                    console.error('Comparison error:', error);
                    alert('Failed to fetch comparison data');
                } finally {
                    hideLoading('mapLoading');
                }
            }

            function displayComparisonResults(data) {
                // Create or update a modal to show comparison results
                let modal = document.getElementById('compareModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'compareModal';
                    modal.className = 'modal fade';
                    modal.innerHTML = `
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Country Comparison</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="compareResults">
                        <!-- Results will be inserted here -->
                    </div>
                </div>
            </div>
        `;
                    document.body.appendChild(modal);
                }

                const resultsContainer = document.getElementById('compareResults');
                resultsContainer.innerHTML = '';

                // Create comparison table
                const table = document.createElement('table');
                table.className = 'table table-striped';

                // Create table header
                const thead = document.createElement('thead');
                thead.innerHTML = `
        <tr>
            <th>Country</th>
            <th>Temperature (°C)</th>
            <th>CO₂ (ppm)</th>
            <th>Deforestation (%)</th>
        </tr>
    `;
                table.appendChild(thead);

                // Create table body
                const tbody = document.createElement('tbody');
                data.forEach(country => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
            <td>${country.country}</td>
            <td>${country.temperature}</td>
            <td>${country.co2}</td>
            <td>${country.deforestation}</td>
        `;
                    tbody.appendChild(row);
                });
                table.appendChild(tbody);

                resultsContainer.appendChild(table);

                // Show the modal
                new bootstrap.Modal(modal).show();
            }

            async function getCountryFromCoordinates(latlng) {
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${latlng.lat}&lon=${latlng.lng}&format=json`);
                    const data = await response.json();
                    return data.address?.country;
                } catch (error) {
                    console.error('Geocoding error:', error);
                    return null;
                }
            }

        </script>

</body>

</html>
